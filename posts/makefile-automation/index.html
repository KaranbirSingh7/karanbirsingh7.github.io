<!DOCTYPE html>
<html lang="en"><head>
	
	<meta name="generator" content="Hugo 0.96.0" />
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	
	<meta property="og:title" content="Makefile automation as part of my development workflow">
	
	
	<meta name="keywords" content="makefile,python,terraform"><meta name="description" content="I have been using Makefile from spinning up docker containers to setting up local dev environment venv (yeah I know I should be using ‚Ä¶"><meta property="og:title" content="Makefile automation as part of my development workflow" />
<meta property="og:description" content="I have been using Makefile from spinning up docker containers to setting up local dev environment venv (yeah I know I should be using docker-compose) and I can safely say its still one of the best tools out for automating tasks.
Recently I included Makefile into this repo so that I can build/publish/run hugo site easily without having to look through documentation on which command to run for local-server or build assets." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://karanbirsingh7.github.io/posts/makefile-automation/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-03T22:13:58-04:00" />
<meta property="article:modified_time" content="2022-04-03T22:13:58-04:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Makefile automation as part of my development workflow"/>
<meta name="twitter:description" content="I have been using Makefile from spinning up docker containers to setting up local dev environment venv (yeah I know I should be using docker-compose) and I can safely say its still one of the best tools out for automating tasks.
Recently I included Makefile into this repo so that I can build/publish/run hugo site easily without having to look through documentation on which command to run for local-server or build assets."/>

	<link rel="stylesheet" type="text/css" media="screen" href="/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="/css/all.css" />
	<link rel="stylesheet" href="/css/katex.min.css" crossorigin="anonymous">
	<script defer src="/js/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
	<script defer src="/js/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
	<script>
		document.addEventListener("DOMContentLoaded", function() {
			renderMathInElement(document.body, {
				delimiters: [
					{left: "$$", right: "$$", display: true},
					{left: "$", right: "$", display: false}
				]
		});
		});
	</script><title>Makefile automation as part of my development workflow | Karanbir Singh</title>


</head>
<body><header>
	
	<div id="avatar">
		<a href="https://karanbirsingh7.github.io/">
		  <img src="/img/avatar.png" alt="Karanbir Singh">
		</a>
	</div>
	
	<div id="titletext"><h2 id="title"><a href="https://karanbirsingh7.github.io/">Karanbir Singh</a></h2></div>
	<div id="title-description"><p id="subtitle">Platform Reliability Engineer @ Manulife | Working with Cloud &amp; Containers</p><div id="social">
			<nav>
				<ul>
					<li><a href="https://github.com/karanbirsingh7"><i title="Github" class="icons fab fa-github"></i></a></li><li><a href="mailto:karanbirsingh1161@gmail.com"><i title="Email" class="icons fas fa-envelope"></i></a></li></ul>
			</nav>
		</div>
	</div>
	
	<div id="mainmenu">
		<nav>
			<ul>
				
				<li><a href="/">Home</a></li>
				
				<li><a href="/posts">All Posts</a></li>
				
				<li><a href="/about">About</a></li>
				
				<li><a href="/tags">Tags</a></li>
				
				<li><a href="/categories">Categories</a></li>
				
			</ul>
		</nav>
	</div>
	
</header>
<main><div class="post">
	
	<div class="author">
	
	</div>
	<div class="post-header">
	
		<div class="meta">
			
			<div class="date">
				<span class="day">03</span>
				<span class="rest">Apr 2022</span>
			</div>
			
		</div>
		
		<div class="matter">
			<h1 class="title">Makefile automation as part of my development workflow</h1>
		</div>
	</div>
	<div class="markdown">
		<p>I have been using Makefile from spinning up docker containers to setting up local dev environment <code>venv</code> (<em>yeah I know I should be using docker-compose</em>) and I can safely say its still one of the best tools out for automating tasks.</p>
<p>Recently I included Makefile into this repo so that I can build/publish/run hugo site easily without having to look through documentation on which command to run for local-server or build assets.</p>
<p>Interesting problem I ran into was how to read &ldquo;user input&rdquo; in Makefile and use that input to do something.
In my case I wanted to read name of new blog from user and run underlying <code>hugo</code> commmand to create a new markdown page in <code>posts/</code></p>
<p>Thankfully <a href="https://stackoverflow.com/questions/12170339/read-input-variable-in-makefile-and-set-variable-upon-its-name/12170504" target="_blank">StackOverflow</a>
 and <a href="https://erictleung.com/user-input-makefile" target="_blank">this article</a>
already had me covered üòä and I was able to overcome this using following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#888"># file: Makefile.hugo</span>
</span></span><span style="display:flex;"><span>.PHONY: create-new-post
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>create-new-post:
</span></span><span style="display:flex;"><span>    @echo <span style="background-color:#fff0f0">&#34;got a name for new post?&#34;</span>; <span style="color:#666;background-color:#fff0f0;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#666;background-color:#fff0f0;font-weight:bold"></span>    <span style="color:#007020">read</span> POSTNAME; <span style="color:#666;background-color:#fff0f0;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#666;background-color:#fff0f0;font-weight:bold"></span>    <span style="color:#007020">echo</span> <span style="background-color:#fff0f0">&#34;creating new post </span><span style="color:#963">$$</span><span style="background-color:#fff0f0">POSTNAME&#34;</span>
</span></span></code></pre></div><blockquote>
<p>You might look at above code and ask why commands need to be chained together? Answer is that each command in Makefile run in its own subshell and that results in variable unable to survive. Putting them on single line or chaining them works.</p>
</blockquote>
<h3 id="bonus-">Bonus ‚≠ê</h3>
<p>Here&rsquo;s list of useful Makefiles that I use across my projects:</p>
<p><strong>Python</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#888"># ref: https://venthur.de/2021-03-31-python-makefiles.html</span>
</span></span><span style="display:flex;"><span><span style="color:#888"># system python interpreter. used only to create virtual environment</span>
</span></span><span style="display:flex;"><span><span style="color:#963">PY</span> <span style="color:#333">=</span> python3
</span></span><span style="display:flex;"><span><span style="color:#963">VENV</span> <span style="color:#333">=</span> venv
</span></span><span style="display:flex;"><span><span style="color:#963">BIN</span><span style="color:#333">=</span><span style="color:#080;font-weight:bold">$(</span>VENV<span style="color:#080;font-weight:bold">)</span>/bin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#888"># make it work on windows too</span>
</span></span><span style="display:flex;"><span>ifeq <span style="color:#333">(</span><span style="color:#080;font-weight:bold">$(</span>OS<span style="color:#080;font-weight:bold">)</span>, Windows_NT<span style="color:#333">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#963">BIN</span><span style="color:#333">=</span><span style="color:#080;font-weight:bold">$(</span>VENV<span style="color:#080;font-weight:bold">)</span>/Scripts
</span></span><span style="display:flex;"><span>    <span style="color:#963">PY</span><span style="color:#333">=</span>python
</span></span><span style="display:flex;"><span>endif
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">$(</span>VENV<span style="color:#080;font-weight:bold">)</span>: requirements.txt
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-weight:bold">$(</span>PY<span style="color:#080;font-weight:bold">)</span> -m venv <span style="color:#080;font-weight:bold">$(</span>VENV<span style="color:#080;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-weight:bold">$(</span>BIN<span style="color:#080;font-weight:bold">)</span>/pip install --upgrade -r requirements.txt
</span></span><span style="display:flex;"><span>	touch <span style="color:#080;font-weight:bold">$(</span>VENV<span style="color:#080;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	@echo <span style="background-color:#fff0f0">&#34;virtualenv created.&#34;</span>
</span></span><span style="display:flex;"><span>	@echo <span style="background-color:#fff0f0">&#34;activate venv in current session by running -&gt; . ./</span><span style="color:#080;font-weight:bold">$(</span>BIN<span style="color:#080;font-weight:bold">)</span><span style="background-color:#fff0f0">/activate &#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>.PHONY: <span style="color:#080;font-weight:bold">$(</span>VENV<span style="color:#080;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>clean:
</span></span><span style="display:flex;"><span>	rm -rf <span style="color:#080;font-weight:bold">$(</span>VENV<span style="color:#080;font-weight:bold">)</span>
</span></span></code></pre></div><p><strong>Terraform</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#888"># from: https://www.sapranidis.gr/working-with-terraform-and-makefile/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SHELL:<span style="color:#333">=</span>/bin/bash
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>all: plan
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>clean:
</span></span><span style="display:flex;"><span>	rm -f /tmp/plan_stg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>get:
</span></span><span style="display:flex;"><span>	@echo <span style="background-color:#fff0f0">&#34;Updating modules&#34;</span>
</span></span><span style="display:flex;"><span>	@terraform get -update
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>format:
</span></span><span style="display:flex;"><span>	@echo <span style="background-color:#fff0f0">&#34;Format existing code&#34;</span>
</span></span><span style="display:flex;"><span>	@terraform fmt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>show:
</span></span><span style="display:flex;"><span>	@echo <span style="background-color:#fff0f0">&#34;Showing plan to apply&#34;</span>
</span></span><span style="display:flex;"><span>	@terraform show /tmp/plan_stg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plan: format get
</span></span><span style="display:flex;"><span>	@echo <span style="background-color:#fff0f0">&#34;Checking Infrastracture&#34;</span>
</span></span><span style="display:flex;"><span>	@terraform plan -out /tmp/plan_stg
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-weight:bold">$(</span>MAKE<span style="color:#080;font-weight:bold">)</span> confirm
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-weight:bold">$(</span>MAKE<span style="color:#080;font-weight:bold">)</span> apply
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>apply:
</span></span><span style="display:flex;"><span>	@echo <span style="background-color:#fff0f0">&#34;Applying changes to Infrastracture&#34;</span>
</span></span><span style="display:flex;"><span>	@terraform apply /tmp/plan_stg
</span></span><span style="display:flex;"><span>	@echo <span style="background-color:#fff0f0">&#34;Clean up after myself&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#080;font-weight:bold">$(</span>MAKE<span style="color:#080;font-weight:bold">)</span> clean
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>confirm:
</span></span><span style="display:flex;"><span>	@read -r -t <span style="color:#60e;font-weight:bold">5</span> -p <span style="background-color:#fff0f0">&#34;Type y to apply, otherwise it will abort (timeout in 5 seconds): &#34;</span> CONTINUE; <span style="color:#666;background-color:#fff0f0;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#666;background-color:#fff0f0;font-weight:bold"></span>	<span style="color:#080;font-weight:bold">if</span> <span style="color:#333">[</span> ! <span style="color:#963">$$CONTINUE</span> <span style="color:#333">==</span> <span style="background-color:#fff0f0">&#34;y&#34;</span> <span style="color:#333">]</span> <span style="color:#333">||</span> <span style="color:#333">[</span> -z <span style="color:#963">$$</span>CONTINUE <span style="color:#333">]</span>; <span style="color:#080;font-weight:bold">then</span> <span style="color:#666;background-color:#fff0f0;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#666;background-color:#fff0f0;font-weight:bold"></span>	    <span style="color:#007020">echo</span> <span style="background-color:#fff0f0">&#34;Abort apply.&#34;</span> ; <span style="color:#666;background-color:#fff0f0;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#666;background-color:#fff0f0;font-weight:bold"></span>		<span style="color:#007020">exit</span> 1; <span style="color:#666;background-color:#fff0f0;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#666;background-color:#fff0f0;font-weight:bold"></span>	<span style="color:#080;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>help: 
</span></span><span style="display:flex;"><span>	@echo <span style="background-color:#fff0f0">&#34;Usage: make plan&#34;</span>
</span></span><span style="display:flex;"><span>	@echo <span style="background-color:#fff0f0">&#34;After applying terraform plan it prompt if to apply the changes.&#34;</span>
</span></span><span style="display:flex;"><span>	@echo <span style="background-color:#fff0f0">&#34;Other commands: &#34;</span>
</span></span><span style="display:flex;"><span>	@echo <span style="background-color:#fff0f0">&#34; * make show - to list what the plan will apply &#34;</span>
</span></span><span style="display:flex;"><span>	@echo <span style="background-color:#fff0f0">&#34; * make clean - delete the executed plan, so no files left behind &#34;</span>
</span></span><span style="display:flex;"><span>	@echo <span style="background-color:#fff0f0">&#34; * make get - update the teffarom modules&#34;</span>
</span></span><span style="display:flex;"><span>	@echo <span style="background-color:#fff0f0">&#34; * make format - execute terraform fmt&#34;</span>
</span></span></code></pre></div>
	</div>
	
	
	
	
	
		
	
	
	
	<div class="tags">
		<div class="taxosfloating_left">
			<p>Tags</p>
		</div>
		<div class="termsfloating_right">
			<p>
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			<a href="/tags/makefile/"> makefile </a>
			
			
			
			
			
			
			
			
			
			<a href="/tags/python/"> python </a>
			
			
			
			
			
			<a href="/tags/terraform/"> terraform </a>
			
			
			
			</p>
		</div>
		<div class="clearit"></div>
		
		
		
		
		
	</div></div>

  </main>





</body>
</html>
